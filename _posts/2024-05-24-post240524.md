---
title: K8S 클러스터 Thanos 스택 구축
date: 2024-05-24 19:00 +0900
lastmod: 2024-05-24 19:00 +0900
categories: [Kubernetes]
tags: [Kubernetes, Prometheus, Thanos]
mermaid: true
math: true
---

> 본 글은 ‘[kube-prometheus-stack 모니터링 시스템 구축](https://woobni.github.io/posts/post240513/)’ 포스팅 이후 진행됨
>

# 배경

K8S 클러스터에 구축된 Prometheus들에 대한 고가용성 및 global view 구현하기 위해 Thanos 스택 구축

# Prerequisite

1. Helm v3.14.4
2. kubectl v1.28.2
3. kube-prometheus-stack helm chart v58.2.1
4. S3 Bucket

# Sidecar

> [https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/thanos.md](https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/thanos.md)
>

> [https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#thanosspec](https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#thanosspec)
>

> [https://thanos.io/tip/thanos/storage.md/#s3](https://thanos.io/tip/thanos/storage.md/#s3)
>

## Object Storage Secret 생성

```yaml
type: S3
config:
  bucket: "kubenetes-thanos"
  endpoint: "s3.ap-northeast-2.amazonaws.com"
  region: "ap-northeast-2"
  aws_sdk_auth: false
  access_key: ""
  insecure: false
  signature_version2: false
  secret_key: ""
  session_token: ""
  put_user_metadata: {}
  http_config:
    idle_conn_timeout: 1m30s
    response_header_timeout: 2m
    insecure_skip_verify: false
    tls_handshake_timeout: 10s
    expect_continue_timeout: 1s
    max_idle_conns: 100
    max_idle_conns_per_host: 100
    max_conns_per_host: 0
    tls_config:
      ca_file: ""
      cert_file: ""
      key_file: ""
      server_name: ""
      insecure_skip_verify: false
    disable_compression: false
  trace:
    enable: false
  list_objects_version: ""
  bucket_lookup_type: auto
  send_content_md5: true
  part_size: 67108864
  sse_config:
    type: ""
    kms_key_id: ""
    kms_encryption_context: {}
    encryption_key: ""
  sts_endpoint: ""
prefix: ""
```

```bash
kubectl create secret generic objstore-secret --from-file=objstore.yaml --namespace monitoring
```

## kube-prometheus-stack c**hart values.yaml 수정**

```yaml
# -------------------Promtetheus-------------------
prometheus:
  prometheusSpec:
	  # Prometheus의 데이터 압축을 비활성화
	  # Thanos compactor가 작업할 때 업로드된 데이터가 손상되지 않도록 하는 데 필요
	  # true로 설정하면 --storage.tsdb.max-block-duration=2h 옵션을 Prometheus에 전달
	  disableCompaction: true

    thanos:
      objectStorageConfig:
        existingSecret:
          key: objstore.yaml
          name: objstore-secret

	thanosService:
		enabled: true
		clusterIP: ""
		type: ClusterIP
		portName: grpc
		port: 10901
		targetPort: "grpc"
		httpPortName: http
		httpPort: 10902
		targetHttpPort: "http"
		clusterIP: ""
		nodePort: 30901
		httpNodePort: 30902

prometheusOperator:
	prometheusConfigReloader:
	  thanosImage:
	    registry: quay.io
	    repository: thanos/thanos
	    tag: v0.34.1
	    sha: ""
```

```bash
helm upgrade -f custom-values.yaml kube-prometheus-stack prometheus-community/kube-prometheus-stack -n monitoring
```

## Thanos Sidecar 확인

```bash
kubectl get pod prometheus-kube-prometheus-stack-prometheus-0 -n monitoring -o yaml

...
status:
  containerStatuses:
  - containerID: containerd://4d837c419903774587ef0dfc35c5869782f61ed9d5413e11996c7ef9ab0292ac
    image: quay.io/thanos/thanos:v0.34.1
    imageID: quay.io/thanos/thanos@sha256:567346c3f6ff2927c2c6c0daad977b2213f62d45eca54d48afd19e6deb902181
    lastState: {}
    name: thanos-sidecar
    ready: true
    restartCount: 0
    started: true
    state:
      running:
        startedAt: "2024-05-17T06:10:07Z"
  hostIP: 192.168.25.221
  hostIPs:
  - ip: 192.168.25.221
...
```

prometheus pod에 statefulset으로 Thanos Sidecar가 배포된 것을 확인할 수 있음

```bash
kubectl get svc -n monitoring

NAME                                             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                         AGE
kube-prometheus-stack-thanos-discovery           ClusterIP   10.97.125.31     <none>        10901/TCP,10902/TCP             54m
```

Thanos Sidecar 엔드포인트를 위한 service도 생성됨을 확인

```bash
kubectl describe pod prometheus-kube-prometheus-stack-prometheus-0 -n monitoring

...
thanos-sidecar:
  State:          Running
    Started:      Fri, 17 May 2024 17:33:12 +0900
  Ready:          True
  Restart Count:  0
  Environment:
    OBJSTORE_CONFIG:  <set to the key 'objstore.yaml' in secret 'objstore-secret'>
...
```

Environment에 OBJSTORE_CONFIG 가 설정되어 있는지 확인

## S3 확인

![Untitled](/assets/img/2024-05-24-post240524/Untitled.png)

## 참고) Secret config 변경

```bash
kubectl delete secret objstore-secret -n monitoring
kubectl create secret generic objstore-secret --from-file=objstore.yaml --namespace monitoring
kubectl rollout restart statefulset prometheus-kube-prometheus-stack-prometheus -n monitoring
```
