<!DOCTYPE html><html lang="en" data-mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동" /><meta property="og:locale" content="en" /><meta name="description" content="본 글은 ‘(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축’ 포스팅 이후 진행됨" /><meta property="og:description" content="본 글은 ‘(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축’ 포스팅 이후 진행됨" /><link rel="canonical" href="https://woobni.github.io/posts/post240524/" /><meta property="og:url" content="https://woobni.github.io/posts/post240524/" /><meta property="og:site_name" content="woobni’s diary." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-24T19:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동" /> <script type="application/ld+json"> {"description":"본 글은 ‘(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축’ 포스팅 이후 진행됨","url":"https://woobni.github.io/posts/post240524/","@type":"BlogPosting","headline":"(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동","dateModified":"2024-07-17T09:59:59+09:00","datePublished":"2024-05-24T19:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://woobni.github.io/posts/post240524/"},"@context":"https://schema.org"}</script><title>(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동 | woobni's diary.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="woobni's diary."><meta name="application-name" content="woobni's diary."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/%EB%82%B4%EC%82%AC%EC%A7%84.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">woobni's diary.</a></div><div class="site-subtitle font-italic">Connecting the dots.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/woobni" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['woobni0357','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/woobni">woobni</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2024-05-24 19:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Fri, May 24, 2024, 7:00 PM +0900" >May 24</em> </span> <span> Updated <em class="timeago" date="2024-07-17 09:59:59 +0900 " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 17, 2024, 9:59 AM +0900" >Jul 17</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3110 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><blockquote><p>본 글은 ‘<a href="https://woobni.github.io/posts/post240516/">(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축</a>’ 포스팅 이후 진행됨</p></blockquote><h1 id="background">Background</h1><ul><li>K8S 클러스터에 구성된 Prometheus 기반 모니터링 스택의 Prometheus HA, 메트릭 장기 저장, global view를 구현하기 위해 Thanos 스택 연동<li>각 Thanos 컴포넌트에 ServiceMonitor를 생성하여 Thanos 컴포넌트 메트릭 추가 수집</ul><h1 id="prerequisite">Prerequisite</h1><ol><li>Helm v3.14.4<li>kubectl v1.28.2<li>Monitoring Stack Setup<ul><li>kube-prometheus-stack helm chart v58.2.1</ul><li>Object Storage</ol><h1 id="prerequisite-1">Prerequisite</h1><ol><li>Helm v3.14.4<li>kubectl v1.28.2<li>kube-prometheus-stack helm chart v58.2.1<li>S3 Bucket</ol><h1 id="thanos-sidecar">Thanos Sidecar</h1><h2 id="create-object-storage-secret">Create Object Storage Secret <a href="#create-object-storage-secret" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><blockquote><p><a href="https://thanos.io/tip/thanos/storage.md/#s3">https://thanos.io/tip/thanos/storage.md/#s3</a></p></blockquote><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="na">type</span><span class="pi">:</span> <span class="s">S3</span>
<span class="na">config</span><span class="pi">:</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kubenetes-thanos"</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3.ap-northeast-2.amazonaws.com"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ap-northeast-2"</span>
  <span class="na">aws_sdk_auth</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">insecure</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">signature_version2</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">secret_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">session_token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">put_user_metadata</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">http_config</span><span class="pi">:</span>
    <span class="na">idle_conn_timeout</span><span class="pi">:</span> <span class="s">1m30s</span>
    <span class="na">response_header_timeout</span><span class="pi">:</span> <span class="s">2m</span>
    <span class="na">insecure_skip_verify</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">tls_handshake_timeout</span><span class="pi">:</span> <span class="s">10s</span>
    <span class="na">expect_continue_timeout</span><span class="pi">:</span> <span class="s">1s</span>
    <span class="na">max_idle_conns</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">max_idle_conns_per_host</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">max_conns_per_host</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">tls_config</span><span class="pi">:</span>
      <span class="na">ca_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">cert_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">key_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">server_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">insecure_skip_verify</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">disable_compression</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">trace</span><span class="pi">:</span>
    <span class="na">enable</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">list_objects_version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket_lookup_type</span><span class="pi">:</span> <span class="s">auto</span>
  <span class="na">send_content_md5</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">part_size</span><span class="pi">:</span> <span class="m">67108864</span>
  <span class="na">sse_config</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">kms_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">kms_encryption_context</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">encryption_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">sts_endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl create secret generic thanos-objstore <span class="nt">--from-file</span><span class="o">=</span>thanos-objstore.yaml <span class="nt">--namespace</span> monitoring
</pre></table></code></div></div><ul><li>S3의 access_key, secret_key 설정</ul><h2 id="customizing-the-chart-valuesyaml">Customizing the Chart values.yaml <a href="#customizing-the-chart-valuesyaml" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="c1"># -------------------Promtetheus-------------------</span>
<span class="na">prometheus</span><span class="pi">:</span>
  <span class="na">prometheusSpec</span><span class="pi">:</span>
    <span class="c1"># Prometheus의 데이터 압축을 비활성화</span>
    <span class="c1"># Thanos compactor가 작업할 때 업로드된 데이터가 손상되지 않도록 하는 데 필요</span>
    <span class="c1"># true로 설정하면 --storage.tsdb.max-block-duration=2h 옵션을 Prometheus에 전달</span>
    <span class="c1"># thanos 설정 시 자동으로 true로 설정됨</span>
<span class="err">	</span>  <span class="na">disableCompaction</span><span class="pi">:</span> <span class="no">true</span>

<span class="err">	</span>  <span class="c1"># Object Storage Secret 설정</span>
    <span class="na">thanos</span><span class="pi">:</span>
      <span class="na">objectStorageConfig</span><span class="pi">:</span>
        <span class="na">existingSecret</span><span class="pi">:</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">thanos-objstore.yaml</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-objstore</span>

<span class="err">	</span><span class="c1"># Thanos Sidecar에서 Thanos 서비스 발견을 위한 서비스</span>
<span class="err">	</span><span class="c1"># 활성화하면 Thanos Query가 --store=dnssrv+_grpc._tcp.${kube-prometheus-stack.fullname}-thanos-discovery.${namespace}.svc.cluster.local를 사용하여 Prometheus 노드에서 Thanos 사이드카를 발견할 수 있음</span>
<span class="err">	</span><span class="na">thanosService</span><span class="pi">:</span>
<span class="err">		</span><span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">		clusterIP</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="err">		</span><span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
<span class="na">		portName</span><span class="pi">:</span> <span class="s">grpc</span>
<span class="na">		port</span><span class="pi">:</span> <span class="m">10901</span>
<span class="err">		</span><span class="na">targetPort</span><span class="pi">:</span> <span class="s2">"</span><span class="s">grpc"</span>
<span class="err">		</span><span class="na">httpPortName</span><span class="pi">:</span> <span class="s">http</span>
<span class="na">		httpPort</span><span class="pi">:</span> <span class="m">10902</span>
<span class="err">		</span><span class="na">targetHttpPort</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http"</span>
<span class="err">		</span><span class="na">clusterIP</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <span class="c1"># None에서 변경</span>
<span class="err">		</span><span class="na">nodePort</span><span class="pi">:</span> <span class="m">30901</span>
<span class="err">		</span><span class="na">httpNodePort</span><span class="pi">:</span> <span class="m">30902</span>

<span class="err">	</span><span class="c1"># Thanos Sidecar의 메트릭을 수집하기 위한 서비스 모니터 설정</span>
<span class="err">	</span><span class="na">thanosServiceMonitor</span><span class="pi">:</span>
<span class="err">	</span>    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>

<span class="c1"># Thanos 이미지 버전 설정</span>
<span class="na">prometheusOperator</span><span class="pi">:</span>
<span class="err">	</span><span class="na">prometheusConfigReloader</span><span class="pi">:</span>
<span class="err">	</span>  <span class="na">thanosImage</span><span class="pi">:</span>
<span class="err">	</span>    <span class="na">registry</span><span class="pi">:</span> <span class="s">quay.io</span>
<span class="na">	    repository</span><span class="pi">:</span> <span class="s">thanos/thanos</span>
<span class="na">	    tag</span><span class="pi">:</span> <span class="s">v0.34.1</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>helm upgrade <span class="nt">-f</span> custom-values.yaml kube-prometheus-stack prometheus-community/kube-prometheus-stack <span class="nt">-n</span> monitoring
</pre></table></code></div></div><h2 id="thanos-sidecar-확인">Thanos Sidecar 확인 <a href="#thanos-sidecar-확인" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>kubectl get pod prometheus-kube-prometheus-stack-prometheus-0 <span class="nt">-n</span> monitoring <span class="nt">-o</span> yaml

...
status:
  containerStatuses:
  - containerID: containerd://4d837c419903774587ef0dfc35c5869782f61ed9d5413e11996c7ef9ab0292ac
    image: quay.io/thanos/thanos:v0.34.1
    imageID: quay.io/thanos/thanos@sha256:567346c3f6ff2927c2c6c0daad977b2213f62d45eca54d48afd19e6deb902181
    lastState: <span class="o">{}</span>
    name: thanos-sidecar
    ready: <span class="nb">true
    </span>restartCount: 0
    started: <span class="nb">true
    </span>state:
      running:
        startedAt: <span class="s2">"2024-05-17T06:10:07Z"</span>
  hostIP: 192.168.25.221
  hostIPs:
  - ip: 192.168.25.221
...
</pre></table></code></div></div><p>prometheus pod에 statefulset으로 Thanos Sidecar가 배포된 것을 확인할 수 있음</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>kubectl get svc <span class="nt">-n</span> monitoring

NAME                                             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                         AGE
kube-prometheus-stack-thanos-discovery           ClusterIP   10.97.125.31     &lt;none&gt;        10901/TCP,10902/TCP             54m
</pre></table></code></div></div><p>Thanos Sidecar 엔드포인트를 위한 service도 생성됨을 확인</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>kubectl describe pod prometheus-kube-prometheus-stack-prometheus-0 <span class="nt">-n</span> monitoring

...
thanos-sidecar:
  State:          Running
    Started:      Fri, 17 May 2024 17:33:12 +0900
  Ready:          True
  Restart Count:  0
  Environment:
    OBJSTORE_CONFIG:  &lt;<span class="nb">set </span>to the key <span class="s1">'thanos-objstore.yaml'</span> <span class="k">in </span>secret <span class="s1">'thanos-objstore'</span><span class="o">&gt;</span>
...
</pre></table></code></div></div><p>Environment에 OBJSTORE_CONFIG 가 설정되어 있는지 확인</p><h2 id="s3-확인">S3 확인 <a href="#s3-확인" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/2024-05-24-post240524/Untitled.png" alt="Untitled" data-proofer-ignore></p><p>2시간 이후부터 메트릭이 적재됨. 2시간 동안의 메트릭은 Prometheus에 존재</p><h2 id="참고-secret-config-변경">참고) Secret config 변경 <a href="#참고-secret-config-변경" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>kubectl delete secret thanos-objstore <span class="nt">-n</span> monitoring
kubectl create secret generic thanos-objstore <span class="nt">--from-file</span><span class="o">=</span>thanos-objstore.yaml <span class="nt">-n</span> monitoring
kubectl rollout restart statefulset prometheus-kube-prometheus-stack-prometheus <span class="nt">-n</span> monitoring
</pre></table></code></div></div><h1 id="thanos-querier">Thanos Querier</h1><blockquote><p><a href="https://thanos.io/tip/thanos/quick-tutorial.md/#querierquery">https://thanos.io/tip/thanos/quick-tutorial.md/#querierquery</a></p></blockquote><p>Thanos Querier는 Prometheus 쿼리를 실행하고 여러 데이터 소스에서 데이터를 집계하여 제공하는 API 게이트웨이</p><h2 id="serviceaccount">ServiceAccount <a href="#serviceaccount" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</pre></table></code></div></div><ul><li>Kubernetes에서는 RBAC(Role-Based Access Control)를 사용하여 클러스터 내의 리소스에 대한 접근 권한을 관리. ServiceAccount는 Pod가 클러스터 내에서 특정 리소스에 접근할 수 있도록 권한을 부여하는 데 사용. 서로 다른 Thanos 컴포넌트(thanos-compact, thanos-query, …)에 대해 개별적인 ServiceAccount를 사용하여 서비스 간의 역할을 분리하고, 각 서비스가 필요한 권한만 부여받도록 하고자 함</ul><h2 id="service">Service <a href="#service" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grpc</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">10901</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">10901</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">9090</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">32090</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</pre></table></code></div></div><h2 id="deployment">Deployment <a href="#deployment" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">podAntiAffinity</span><span class="pi">:</span>
          <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">podAffinityTerm</span><span class="pi">:</span>
              <span class="na">labelSelector</span><span class="pi">:</span>
                <span class="na">matchExpressions</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
                  <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                  <span class="na">values</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s">thanos-query</span>
              <span class="na">namespaces</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">monitoring</span>
              <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
            <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">query</span>
        <span class="pi">-</span> <span class="s">--grpc-address=0.0.0.0:10901</span>
        <span class="pi">-</span> <span class="s">--http-address=0.0.0.0:9090</span>
        <span class="pi">-</span> <span class="s">--log.level=debug</span>
        <span class="pi">-</span> <span class="s">--log.format=logfmt</span>
        <span class="pi">-</span> <span class="s">--query.replica-label=prometheus_replica</span>
        <span class="pi">-</span> <span class="s">--endpoint=dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local</span>
        <span class="pi">-</span> <span class="s">--query.timeout=5m</span>
        <span class="pi">-</span> <span class="s">--query.lookback-delta=15m</span>
        <span class="pi">-</span> <span class="pi">|-</span>
          <span class="s">--tracing.config="config":</span>
            <span class="s">"sampler_param": 2</span>
            <span class="s">"sampler_type": "ratelimiting"</span>
            <span class="s">"service_name": "thanos-query"</span>
          <span class="s">"type": "JAEGER"</span>
        <span class="pi">-</span> <span class="s">--query.auto-downsampling</span>
        <span class="pi">-</span> <span class="s">--web.external-prefix=/thanos/query</span>
        <span class="c1">#- --web.route-prefix=/thanos/query</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">HOST_IP_ADDRESS</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.hostIP</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.34.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">4</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/healthy</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">10901</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">grpc</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9090</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">20</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">resources</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ALL</span>
          <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">65532</span>
          <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
          <span class="na">seccompProfile</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
        <span class="na">terminationMessagePolicy</span><span class="pi">:</span> <span class="s">FallbackToLogsOnError</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">65532</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">seccompProfile</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">thanos-query</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">120</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">--endpoint=dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitoring.svc.cluster.local</code>: thanos-sidecar의 svc 지정</ul><h2 id="servicemonitor">ServiceMonitor <a href="#servicemonitor" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceMonitor</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
    <span class="na">tenant</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-query</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">relabelings</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
      <span class="na">separator</span><span class="pi">:</span> <span class="s">/</span>
      <span class="na">sourceLabels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">namespace</span>
      <span class="pi">-</span> <span class="s">pod</span>
      <span class="na">targetLabel</span><span class="pi">:</span> <span class="s">instance</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">query-layer</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-query</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-query</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> thanos-query-serviceAccount.yaml <span class="nt">-f</span> thanos-query-service.yaml <span class="nt">-f</span> thanos-query-deployment.yaml <span class="nt">-f</span> thanos-query-serviceMonitor.yaml
</pre></table></code></div></div><h2 id="확인">확인 <a href="#확인" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%201.png" alt="Untitled" data-proofer-ignore></p><p>NodePort로 Thanos Query에 접속 후 위와 같이 sidecar가 store 설정 되어 있음을 확인</p><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%202.png" alt="Untitled" data-proofer-ignore></p><p>Thanos Query의 ServiceMonitor도 Target에 설정 되어 있음을 확인</p><h1 id="thanos-compactor">Thanos Compactor</h1><blockquote><p><a href="https://thanos.io/tip/components/compact.md">https://thanos.io/tip/components/compact.md</a></p></blockquote><p>Thanos Compactor는 Prometheus TSDB(시계열 데이터베이스) 블록을 관리하고 최적화하는 구성 요소. 다음과 같은 작업을 수행:</p><ol><li>블록 컴팩션<ul><li>여러 개의 작은 블록을 큰 블록으로 병합하여 디스크 사용량을 줄이고 쿼리 성능을 향상시킴.<li>컴팩션 과정에서 데이터가 삭제될 수도 있으므로 데이터 무결성을 유지해야 합니다.</ul><li>다운샘플링<ul><li>장기 저장소의 데이터 크기를 줄이기 위해 시간 시계열 데이터를 다운샘플링하여 저장.<li>이를 통해 장기 저장된 데이터에 대한 쿼리 성능을 개선.</ul><li>블록 삭제<ul><li>오래된 블록을 삭제하여 디스크 공간을 확보.<li>특정 보존 정책에 따라 데이터를 관리.</ul></ol><h2 id="serviceaccount-1">ServiceAccount <a href="#serviceaccount-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</pre></table></code></div></div><h2 id="service-1">Service <a href="#service-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">10902</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">32091</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>

</pre></table></code></div></div><h2 id="statefultset">StatefultSet <a href="#statefultset" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Compactor는 TSDB 블록 압축을 수행하기 위해 데이터를 저장하고 버킷 상태 캐시를 유지하기 위한 로컬 디스크 공간이 필요함. <a href="https://thanos.io/tip/components/compact.md/#disk">디스크에 있는 데이터는 컴팩터가 재시작 사이에 버킷 상태 캐시를 효과적으로 사용하기 위해 지속적인 디스크를 제공하는 것이 권장됨</a>. 따라서 StatefulSet으로 배포하여 안정적인 스토리지를 보장</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.35.1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">podAntiAffinity</span><span class="pi">:</span>
          <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">podAffinityTerm</span><span class="pi">:</span>
              <span class="na">labelSelector</span><span class="pi">:</span>
                <span class="na">matchExpressions</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/name</span>
                  <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                  <span class="na">values</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s">thanos-compact</span>
                <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">app.kubernetes.io/instance</span>
                  <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                  <span class="na">values</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s">thanos-compact</span>
              <span class="na">namespaces</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">monitoring</span>
              <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
            <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">compact</span>
        <span class="pi">-</span> <span class="s">--web.disable</span>
        <span class="pi">-</span> <span class="s">--web.disable-cors</span>
        <span class="pi">-</span> <span class="s">--wait</span>
        <span class="pi">-</span> <span class="s">--log.level=warn</span>
        <span class="pi">-</span> <span class="s">--log.format=logfmt</span>
        <span class="pi">-</span> <span class="s">--objstore.config=$(OBJSTORE_CONFIG)</span>
        <span class="pi">-</span> <span class="s">--data-dir=/var/thanos/compact</span>
        <span class="pi">-</span> <span class="s">--debug.accept-malformed-index</span>
        <span class="pi">-</span> <span class="s">--retention.resolution-raw=0d</span>
        <span class="pi">-</span> <span class="s">--retention.resolution-5m=0d</span>
        <span class="pi">-</span> <span class="s">--retention.resolution-1h=0d</span>
        <span class="pi">-</span> <span class="s">--delete-delay=12h</span>
        <span class="pi">-</span> <span class="s">--compact.concurrency=1</span>
        <span class="pi">-</span> <span class="s">--downsample.concurrency=1</span>
        <span class="pi">-</span> <span class="s">--downsampling.disable</span>
        <span class="pi">-</span> <span class="s">--deduplication.replica-label=prometheus_replica</span>
        <span class="pi">-</span> <span class="s">--deduplication.replica-label=rule_replica</span>
        <span class="pi">-</span> <span class="pi">|-</span>
          <span class="s">--tracing.config="config":</span>
            <span class="s">"sampler_param": 2</span>
            <span class="s">"sampler_type": "ratelimiting"</span>
            <span class="s">"service_name": "thanos-compact"</span>
          <span class="s">"type": "JAEGER"</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OBJSTORE_CONFIG</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">thanos-objstore.yaml</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-objstore</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">HOST_IP_ADDRESS</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.hostIP</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.34.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">4</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/healthy</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">10902</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">20</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">terminationMessagePolicy</span><span class="pi">:</span> <span class="s">FallbackToLogsOnError</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/thanos/compact</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">65532</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">seccompProfile</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">thanos-compact</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">120</span>
      <span class="na">volumes</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">storageClassName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nfs-client"</span>
      <span class="na">accessModes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">storage</span><span class="pi">:</span> <span class="s">10Gi</span>
</pre></table></code></div></div><ul><li>사전에 구성된 Object Storage Secret 설정 ```yaml<ul><li>name: OBJSTORE_CONFIG valueFrom: secretKeyRef: key: thanos-objstore.yaml name: thanos-objstore ```</ul></ul><h2 id="servicemonitor-1">ServiceMonitor <a href="#servicemonitor-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceMonitor</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
    <span class="na">tenant</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">relabelings</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
      <span class="na">separator</span><span class="pi">:</span> <span class="s">/</span>
      <span class="na">sourceLabels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">namespace</span>
      <span class="pi">-</span> <span class="s">pod</span>
      <span class="na">targetLabel</span><span class="pi">:</span> <span class="s">instance</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">database-compactor</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-compact</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-compact</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> thanos-compact-serviceAccount.yaml <span class="nt">-f</span> thanos-compact-service.yaml <span class="nt">-f</span> thanos-compact-statefulSet.yaml <span class="nt">-f</span> thanos-compact-serviceMonitor.yaml
</pre></table></code></div></div><h2 id="prometheus-target-확인">Prometheus Target 확인 <a href="#prometheus-target-확인" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%203.png" alt="Untitled" data-proofer-ignore></p><p>Thanos Compactor의 ServiceMonitor도 Target에 설정 되어 있음을 확인</p><h1 id="grafana에서-thanos-query를-통해-메트릭-조인">Grafana에서 Thanos Query를 통해 메트릭 조인</h1><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%204.png" alt="Untitled" data-proofer-ignore></p><p>Grafana에 접속하여 Thanos Querier를 데이터소스로 추가. Connection 섹션의 URL 필드에 다음 URL을 입력</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://thanos-query.monitoring:9090/
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">thanos-query.monitoring</code>: 네임스페이스는 <code class="language-plaintext highlighter-rouge">monitoring</code>이고 서비스 이름은 <code class="language-plaintext highlighter-rouge">thanos-query</code></p><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%205.png" alt="Untitled" data-proofer-ignore></p><p>Prometheus type을 Thanos로 설정</p><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%206.png" alt="Untitled" data-proofer-ignore></p><p>Thanos Querier를 데이터소스로 하여 메트릭 조회. 아래와 같은 과정을 Thanos가 수행:</p><ul><li>2시간 내 메트릭은 Prometheus에서 조회<li>Prometheus의 보존 기간(일반적으로 2시간)보다 오래된 모든 메트릭이 Object Storage에서 조회</ul><p>일반적인 설정에서는 Prometheus 서버가 짧은 보존 기간(예: 2시간)으로 구성됨. 이 보존 기간보다 오래된 모든 데이터는 더 큰 블록으로 압축되어 Thanos Sidecar에 의해 Object Storage로 업로드됨. 히스토리 데이터를 요청할 때 Object Storage에 있는 이러한 블록을 조회.</p><h1 id="thanos-bucket-web">Thanos Bucket Web</h1><blockquote><p><a href="https://thanos.io/tip/components/tools.md/#bucket-web">https://thanos.io/tip/components/tools.md/#bucket-web</a></p></blockquote><p>Thanos Bucket Web은 웹 UI를 통해 Thanos 스토리지 버킷의 상태를 검사하고 주어진 갱신 주기로 뷰를 주기적으로 업데이트</p><h2 id="serviceaccount-2">ServiceAccount <a href="#serviceaccount-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</pre></table></code></div></div><h2 id="service-2">Service <a href="#service-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">10902</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</pre></table></code></div></div><h2 id="deployment-1">Deployment <a href="#deployment-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
    <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
      <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">object-store-bucket-debugging</span>
        <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
        <span class="na">app.kubernetes.io/version</span><span class="pi">:</span> <span class="s">v0.34.1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">tools</span>
        <span class="pi">-</span> <span class="s">bucket</span>
        <span class="pi">-</span> <span class="s">web</span>
        <span class="pi">-</span> <span class="s">--log.level=warn</span>
        <span class="pi">-</span> <span class="s">--log.format=logfmt</span>
        <span class="pi">-</span> <span class="s">--objstore.config=$(OBJSTORE_CONFIG)</span>
        <span class="pi">-</span> <span class="s">--web.external-prefix=/thanos/bucket</span>
        <span class="pi">-</span> <span class="s">--web.route-prefix=/thanos/bucket</span>
        <span class="pi">-</span> <span class="pi">|-</span>
          <span class="s">--tracing.config="config":</span>
            <span class="s">"sampler_param": 2</span>
            <span class="s">"sampler_type": "ratelimiting"</span>
            <span class="s">"service_name": "thanos-bucket"</span>
          <span class="s">"type": "JAEGER"</span>
        <span class="pi">-</span> <span class="s">--label=cluster_name</span>
        <span class="pi">-</span> <span class="s">--refresh=5m</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">OBJSTORE_CONFIG</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">thanos-objstore.yaml</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-objstore</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">HOST_IP_ADDRESS</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.hostIP</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.34.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">4</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/healthy</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">30</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">10902</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">20</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/-/ready</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">10902</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="m">0.42</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">420Mi</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="m">0.123</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">123Mi</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">ALL</span>
          <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">65532</span>
          <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
          <span class="na">seccompProfile</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
        <span class="na">terminationMessagePolicy</span><span class="pi">:</span> <span class="s">FallbackToLogsOnError</span>
        <span class="na">volumeMounts</span><span class="pi">:</span> <span class="pi">[]</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">fsGroup</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">runAsGroup</span><span class="pi">:</span> <span class="m">65532</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span>
        <span class="na">seccompProfile</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">RuntimeDefault</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">thanos-bucket</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">120</span>
      <span class="na">volumes</span><span class="pi">:</span> <span class="pi">[]</span>
</pre></table></code></div></div><ul><li>사전에 구성된 Object Storage Secret 설정 ```yaml<ul><li>name: OBJSTORE_CONFIG valueFrom: secretKeyRef: key: thanos-objstore.yaml name: thanos-objstore ```</ul></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> thanos-bucket-serviceAccount.yaml <span class="nt">-f</span> thanos-bucket-service.yaml <span class="nt">-f</span> thanos-bucket-deployment.yaml
</pre></table></code></div></div><h2 id="bucket-web-접속-확인">Bucket Web 접속 확인 <a href="#bucket-web-접속-확인" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/img/2024-05-24-post240524/Untitled%207.png" alt="Untitled" data-proofer-ignore></p><h1 id="reference">Reference</h1><ol><li><a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/thanos.md">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/thanos.md</a><li><a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#thanosspec">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#thanosspec</a><li><a href="https://github.com/thanos-io/kube-thanos/tree/main/manifests">https://github.com/thanos-io/kube-thanos/tree/main/manifests</a><li><a href="https://github.com/thanos-io/kube-thanos/tree/main/examples/all/manifests">https://github.com/thanos-io/kube-thanos/tree/main/examples/all/manifests</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/prometheus/" class="post-tag no-text-decoration" >Prometheus</a> <a href="/tags/thanos/" class="post-tag no-text-decoration" >Thanos</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동 - woobni's diary.&url=https://woobni.github.io/posts/post240524/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동 - woobni's diary.&u=https://woobni.github.io/posts/post240524/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://woobni.github.io/posts/post240524/&text=(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동 - woobni's diary." data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script src="https://utteranc.es/client.js" repo="woobni/woobni.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/post240516/">(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축</a><li><a href="/posts/post240524/">(kube-prometheus-stack) Prometheus 기반 모니터링 스택 Thanos 연동</a><li><a href="/posts/post240515/">PV, PVC의 동적 프로비저닝을 위한 NFS CSI 드라이버 구성</a><li><a href="/posts/post240402/">자바스크립트 런타임</a><li><a href="/posts/post230927/">도커 엔진</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/codingtest/">CodingTest</a> <a class="post-tag" href="/tags/deep-learning/">Deep Learning</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/javascript/">Javascript</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/contents-caching/">Contents Caching</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/reinforcement-learning/">Reinforcement Learning</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/post240516/"><div class="card-body"> <em class="timeago small" date="2024-05-16 19:00:00 +0900" >May 16</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축</h3><div class="text-muted small"><p> 본 글은 ‘Hyper-v 환경에서 k8s 클러스터 구축’ 포스팅 이후 진행함 Background SaaS 제품을 사용하는 테넌트가 추가됨에 따른 환경 배포 및 관리가 불편해져 기존의 베어메탈 환경에서 쿠버네티스로 전환 기존 Bare-metal 환경에 직접 설치된 모니터링 스택들을 쿠버네티스 클러스터 위에 구축 K8S 클러스터의...</p></div></div></a></div><div class="card"> <a href="/posts/post230329/"><div class="card-body"> <em class="timeago small" date="2023-03-29 19:00:00 +0900" >Mar 29, 2023</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hyper-v 환경에서 k8s 클러스터 구성을 위한 provisioning</h3><div class="text-muted small"><p> 0. 개요 1개의 마스터와 2개의 워커로 구성된 쿠버네티스 클러스터를 구축하는 것이 목표 환경 Host OS: Window11 Hyper-v OS: Rocky-9.1-x86_64-minimal.iso 1. Hyper-v 설정 1) Hyper-V 켜기 실행 창 켜기: Window...</p></div></div></a></div><div class="card"> <a href="/posts/post230423/"><div class="card-body"> <em class="timeago small" date="2023-04-23 19:00:00 +0900" >Apr 23, 2023</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hyper-v 환경에서 k8s 클러스터 구축</h3><div class="text-muted small"><p> 본 글은 ‘쿠버네티스 클러스터 구성을 위한 Hyper-v Provisioning’ 이후 진행함 0. 개요 1개의 Master와 3개의 Worker로 구성된 쿠버네티스 클러스터를 구축하는 것이 목표 환경 Host OS: Window11 Hyper-v OS: Rocky-9.1-x86_64-minima...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/post240516/" class="btn btn-outline-primary" prompt="Older"><p>(kube-prometheus-stack) Prometheus 기반 모니터링 스택 구축</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/woobni">woobni</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/codingtest/">CodingTest</a> <a class="post-tag" href="/tags/deep-learning/">Deep Learning</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/kubernetes/">Kubernetes</a> <a class="post-tag" href="/tags/javascript/">Javascript</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/contents-caching/">Contents Caching</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/reinforcement-learning/">Reinforcement Learning</a> <a class="post-tag" href="/tags/docker/">Docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
